import{U as v,R as L,V as E,W as u,X as U,Y as g,Z as B,$ as R,a0 as m,a1 as C,a2 as h,a3 as w,a4 as P}from"./index.2c9351ad.js";import{c as y,a as b,b as F,d as S}from"./getCacheStaff.7425a190.js";import{c as k}from"./createGarbageFilter.8427473b.js";import{c as D,g as T}from"./user.2315a04a.js";class M extends L{constructor(){super("ContactConfiguration",{contactConfiguration:{},channelConfiguration:new Map})}async getFilters(){return[{kinds:[3],authors:[await E.getPublicKey()]}]}async serializeToData(t){const a={},s=u(t.tags);for(const{name:n,pubkey:e,relayUrl:r}of s)a[e]={name:n,pubkey:e,relayUrl:r};const o=new Map,c=U(t.tags);for(const n of c){const e=g.createChild().addFilter({kinds:[41],"#e":[n.eventId]}).addFilter({ids:[n.eventId],kinds:[40]}).addStaff(y()).addStaff(D());e.feat.onHasLatestEvent(r=>{Object.assign(n,r)}),e.addExtends(g),o.set(n.eventId,n)}return{contactConfiguration:a,channelConfiguration:o}}getContactConfiguration(){return this.getData().contactConfiguration}async deserializeToEvent(t,a){const s=t.contactConfiguration,o=Object.entries(s).map(([e,{name:r,relayUrl:f}])=>["p",e,f,r].filter(Boolean)),c=t.channelConfiguration,n=B(Array.from(c.entries(),([e,r])=>r));return R({kind:3,tags:[...o,...n],created_at:a})}getChannelConfiguration(){return this.getData().channelConfiguration}getChannelList(){return Array.from(this.getChannelConfiguration()).map(([t,a])=>a)}follow(t,a,s){if(!t)return;const o=this.getDataAndChange().contactConfiguration,c=o[t]={pubkey:t,name:s!=null?s:"",relayUrl:a!=null?a:""},n=this.toChanged(),e=T(t),r=m((f,l)=>{if(this.isReChange(n)){e.closeReq();return}if(Object.assign(c,f),f.relayUrls&&f.relayUrls.length>0)c.relayUrl=f.relayUrls[0];else{const d=e.getUrlBySubId(l!=null?l:"");d&&(c.relayUrl=d)}});this.save(),e.feat.onHasMetadata(r)}unFollow(t){if(!t)return;const a=this.getData().contactConfiguration;a[t]!==void 0&&(this.toChanged(),delete a[t],this.save())}isFollow(t){return Boolean(this.getData().contactConfiguration[t])}}const A=v(new M);setTimeout(()=>{A.sync()},0);function O(i,t){return C(`getContactListLineByPubkey:${i}`,()=>{const a=h().addFilter({kinds:[3],authors:[i]}).addStaff(y()).addStaff(w()).addStaff(P()).addStaff({feat:{getContactList(){const o=this.beltline.feat.getLatestEvent();return o?u(o.tags):[]}}}).addStaff(b());return(async()=>{a.addRelayUrls(t==null?void 0:t.urls),a.addStaff(S(i)),a.addReadUrl()})(),a},{useLocalStorage:!1})}function $(i,t){return C(`getFollowerLineByPubkey:${i}`,()=>{const a=h({name:"getFollowerLineByPubkey"}).addStaff(k([{kinds:[3],"#p":[i]}],100)).addStaff(F()).addStaff(S(i)).addReadUrl().addRelayUrls(t==null?void 0:t.urls);return a.feat.load(),a},{useLocalStorage:!1,duration:1e5})}export{$ as a,A as c,O as g};
