var A=Object.defineProperty;var M=(a,t,e)=>t in a?A(a,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):a[t]=e;var s=(a,t,e)=>(M(a,typeof t!="symbol"?t+"":t,e),e);import{aa as u,ab as B,a6 as f,Y as v,ac as w,a4 as R,ad as O,ae as C,af as S,ag as E,ah as L,ai as g,a2 as U,a1 as p,a5 as W,Z as F,aj as T,ak as y}from"./index.263e31e4.js";function k(){const a=new Set;return u({push(t){const e=t.id;if(a.has(e))return B.BREAK;a.add(e)}})}class q{constructor(){s(this,"interval",3e3);s(this,"maximumTimes",30);s(this,"setToBeAdded",new Set);s(this,"added",new Set);s(this,"count",0);s(this,"timer");s(this,"eventBeltline");s(this,"filterMap",new Map)}stop(){clearInterval(this.timer),this.timer=void 0}getIndex(){return Math.floor(Math.random()*this.setToBeAdded.size)}init(){}getEventBeltline(){var t;return(t=this.eventBeltline)!=null?t:this.eventBeltline=v.createChild()}startProcessing(){this.count=0,this.init(),!this.timer&&(this.timer=setInterval(()=>{this.count++;let t=this.setToBeAdded.size;if(t<=0&&(this.setToBeAdded=new Set(w.getOtherList()),t=this.setToBeAdded.size),t<=0||this.filterMap.size<=0||this.count>this.maximumTimes){this.stop();return}const e=this.getIndex(),i=Array.from(this.setToBeAdded)[e];this.added.add(i),this.setToBeAdded.delete(i);const n=Array.from(this.filterMap,([d,o])=>o),r=this.eventBeltline.createChild().addFilters(n).addStaff(R()).addRelayUrls(new Set().add(i));setTimeout(()=>{r.closeReq()},2e4),this.getEventBeltline().addExtends(r)},this.interval))}addFilter(t){for(const e of t)c.filterMap.set(JSON.stringify(e),e);c.startProcessing()}removeFilters(t){if(!!t)for(const e of t)c.filterMap.delete(JSON.stringify(e))}}const c=new q;function x(){let a=null,t=!1;function e(){t=!0,a&&c.removeFilters(a)}function i(){t=!1,a=this.beltline.getFilters();const n=this.beltline.createChild().addFilters(a).addExtends(c.getEventBeltline());this.beltline.addExtends(n),!t&&c.addFilter(a)}return u({initialization(){i.apply(this)},feat:{startAutomaticRandomRequestStaff:i,stopAutomaticRandomRequestStaff:e},onClose(){e()}})}const z=f()(()=>({initialization(){this.beltline.feat.onHasLatestEventOnce(()=>{this.beltline.feat.stopAutomaticRandomRequestStaff()})}})),I=f()(()=>({feat:{onHasReadWriteList(a){this.beltline.feat.onHasLatestEvent((t,e)=>{const i=O(t.tags);a(i,e)})}}})),Y=f()(()=>({feat:{getReadWriteList(){return this.beltline.feat.onHasReadWriteList(a=>{this.readWriteList=a}),this.readWriteList}}})),P=f()(()=>({feat:{withEvent(){return this.beltline.getList().length>0},async timeoutWithEvent(a=2e3){return await C(2e3),this.beltline.feat.withEvent()}}}));class h{constructor(t,e){s(this,"map",{});s(this,"KEY");s(this,"cacheOption");this.cacheOption={duration:1e3*60*60*24,...S,...e==null?void 0:e.cacheOptinos},this.KEY=t;const i=localStorage.getItem(t);if(!i)return;const n=JSON.parse(i);typeof n=="object"&&(this.map=n)}allMap(){const t={},e=this.map;for(const i in e){const n=this.get(i);!n||(t[i]=n)}return t}set(t,e){const i=e.id;this.map[t]=i,E(i,e,this.cacheOption),this.updateMap()}delete(t){delete this.map[t],L(t),this.updateMap()}get(t){return this._getEvent(t)}_getEvent(t){const e=this.map[t];if(!!e)try{return g(e,this.cacheOption)}catch{this.delete(t);return}}updateMap(){localStorage.setItem(this.KEY,JSON.stringify(this.map))}}class m extends h{add(t){this.set(t.pubkey,t)}deleteEventByPubkey(t){this.delete(t)}getByPubkey(t){return this.get(t)}}const H={kind10002:new m("ReplaceableEventMap:kind10002"),kind0:new m("ReplaceableEventMap:kind0"),channelMetadataEventMap:new h("channelMetadataEventMap",{cacheOptinos:{duration:1e3*60*60*8}}),replaceable:new h("replaceable",{cacheOptinos:{duration:1e3*60*20}})},N=f()((a,t)=>({initialization(){const e=H[`kind${a}`],i=e.getByPubkey(t);i&&this.beltline.pushEvent(i),this.beltline.feat.onHasLatestEvent(n=>{e.add(n)})}}));function _(a,t){return u({initialization(){const e=this.beltline,i=U(`autoAddRelayurlByPubkey:${a}`,()=>{const r=e.createChild(),d=r.createChild().addStaff(W()).addStaff(R()).addStaff(k()),o=d.createChild().addFilter({kinds:[10002],authors:[a]}).addStaff(F()).addStaff(N(10002,a)).addStaff(I()).addStaff(P()).onAddFilters(l=>{d.addFilters(l)});return o.feat.onHasReadWriteList(l=>{r.addRelayUrls(l.writeUrl)}),T(`createAddRelayUrlGraspClues:${a}`,()=>{d.addRelayUrls(r.getRelayUrls());const l=p(b=>{d.addRelayUrls(b)},1e3);r.onAddRelayUrlsAfter(l)},y.syncInterval6),d.createChild().addFilter({kinds:[2],authors:[a]}).onAddFilters(l=>{d.addFilters(l)}).addStaff({push(l){r.addRelayUrl(l.content)}}),(async()=>{o.feat.withEvent()||(d.addExtends(v),!o.feat.withEvent()&&(t!=null&&t.urls&&(d.addRelayUrls(t.urls),await o.feat.timeoutWithEvent())||(d.addReadUrl(),!await o.feat.timeoutWithEvent()&&o.addStaff(x()).addStaff(z()))))})(),r},{useLocalStorage:!1}),n=p(r=>{e.addRelayUrls(r)},1e3);i.onAddRelayUrlsAfter(n)}})}const J={duration:y.eventCacheDuration,...S},D=f()((a,t)=>{const e=Object.assign({},J,t);return{initialization(){try{const i=g(a,e);i&&this.beltline.pushEvent(i)}catch{}this.beltline.addStaff({push(i){E(i.id,i,e)}})}}});export{H as R,k as a,_ as b,P as c,N as d,I as e,Y as f,D as g};
