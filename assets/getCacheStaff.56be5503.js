var M=Object.defineProperty;var B=(a,t,e)=>t in a?M(a,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):a[t]=e;var s=(a,t,e)=>(B(a,typeof t!="symbol"?t+"":t,e),e);import{a8 as h,a9 as U,aa as c,Y as m,ab as w,a4 as R,ac as C,ad as L,ae as S,af as g,ag as O,ah as E,a2 as W,a1 as p,a5 as F,Z as T,ai as q,aj as y,U as x}from"./index.7cd35645.js";function z(){const a=new Set;return h({push(t){const e=t.id;if(a.has(e))return U.BREAK;a.add(e)}})}class k{constructor(){s(this,"interval",3e3);s(this,"maximumTimes",30);s(this,"setToBeAdded",new Set);s(this,"added",new Set);s(this,"count",0);s(this,"timer");s(this,"eventBeltline");s(this,"filterMap",new Map)}stop(){clearInterval(this.timer),this.timer=void 0}getIndex(){return Math.floor(Math.random()*this.setToBeAdded.size)}init(){}getEventBeltline(){var t;return(t=this.eventBeltline)!=null?t:this.eventBeltline=m.createChild()}startProcessing(){this.count=0,this.init(),!this.timer&&(this.timer=setInterval(()=>{this.count++;let t=this.setToBeAdded.size;if(t<=0&&(this.setToBeAdded=new Set(w.getOtherList()),t=this.setToBeAdded.size),t<=0||this.filterMap.size<=0||this.count>this.maximumTimes){this.stop();return}const e=this.getIndex(),i=Array.from(this.setToBeAdded)[e];this.added.add(i),this.setToBeAdded.delete(i);const r=Array.from(this.filterMap,([d,o])=>o),n=this.eventBeltline.createChild().addFilters(r).addStaff(R()).addRelayUrls(new Set().add(i));setTimeout(()=>{n.closeReq()},2e4),this.getEventBeltline().addExtends(n)},this.interval))}addFilter(t){for(const e of t)f.filterMap.set(JSON.stringify(e),e);f.startProcessing()}removeFilters(t){if(!!t)for(const e of t)f.filterMap.delete(JSON.stringify(e))}}const f=new k;function I(){let a=null,t=!1;function e(){t=!0,a&&f.removeFilters(a)}function i(){t=!1,a=this.beltline.getFilters();const r=this.beltline.createChild().addFilters(a).addExtends(f.getEventBeltline());this.beltline.addExtends(r),!t&&f.addFilter(a)}return h({initialization(){i.apply(this)},feat:{startAutomaticRandomRequestStaff:i,stopAutomaticRandomRequestStaff:e},onClose(){e()}})}const P=c()(()=>({initialization(){this.beltline.feat.onHasLatestEventOnce(()=>{this.beltline.feat.stopAutomaticRandomRequestStaff()})}})),H=c()(()=>({feat:{onHasReadWriteList(a){this.beltline.feat.onHasLatestEvent((t,e)=>{const i=C(t.tags);a(i,e)})}}})),G=c()(()=>({feat:{getReadWriteList(){return this.beltline.feat.onHasReadWriteList(a=>{this.readWriteList=a}),this.readWriteList}}})),N=c()(()=>({feat:{withEvent(){return this.beltline.getList().length>0},async timeoutWithEvent(a=2e3){return await L(2e3),this.beltline.feat.withEvent()}}}));class b{constructor(t){s(this,"map",{});s(this,"KEY");s(this,"cacheOption",{duration:1e3*60*60*24*3,...S});this.KEY=t;const e=localStorage.getItem(t);if(!e)return;const i=JSON.parse(e);typeof i=="object"&&(this.map=i)}allMap(){const t={},e=this.map;for(const i in e){const r=this.get(i);!r||(t[i]=r)}return t}set(t,e){const i=e.id;this.map[t]=i,g(i,e,this.cacheOption),this.updateMap()}delete(t){delete this.map[t],O(t),this.updateMap()}get(t){return this._getEvent(t)}_getEvent(t){const e=this.map[t];if(!!e)try{return E(e,this.cacheOption)}catch{this.delete(t);return}}updateMap(){localStorage.setItem(this.KEY,JSON.stringify(this.map))}}class v extends b{constructor(t){super(t)}add(t){this.set(t.pubkey,t)}deleteEventByPubkey(t){this.delete(t)}getByPubkey(t){return this.get(t)}}const J={kind10002:new v("ReplaceableEventMap:kind10002"),kind0:new v("ReplaceableEventMap:kind0"),channelMetadataEventMap:new b("channelMetadataEventMap")},_=c()((a,t)=>({initialization(){const e=J[`kind${a}`],i=e.getByPubkey(t);i&&this.beltline.pushEvent(i),this.beltline.feat.onHasLatestEvent(r=>{e.add(r)})}}));function Z(a,t){return h({initialization(){const e=this.beltline,i=W(`autoAddRelayurlByPubkey:${a}`,()=>{const n=e.createChild(),d=n.createChild().addStaff(F()).addStaff(R()).addStaff(z()),o=d.createChild().addFilter({kinds:[10002],authors:[a]}).addStaff(T()).addStaff(_(10002,a)).addStaff(H()).addStaff(N()).onAddFilters(l=>{d.addFilters(l)});return o.feat.onHasReadWriteList(l=>{n.addRelayUrls(l.writeUrl)}),q(`createAddRelayUrlGraspClues:${a}`,()=>{d.addRelayUrls(n.getRelayUrls());const l=p(A=>{d.addRelayUrls(A)},1e3);n.onAddRelayUrlsAfter(l)},y.syncInterval6),d.createChild().addFilter({kinds:[2],authors:[a]}).onAddFilters(l=>{d.addFilters(l)}).addStaff({push(l){n.addRelayUrl(l.content)}}),(async()=>{o.feat.withEvent()||(d.addExtends(m),!o.feat.withEvent()&&(t!=null&&t.urls&&(d.addRelayUrls(t.urls),await o.feat.timeoutWithEvent())||(d.addReadUrl(),!await o.feat.timeoutWithEvent()&&o.addStaff(I()).addStaff(P()))))})(),n},{useLocalStorage:!1}),r=p(n=>{e.addRelayUrls(n)},1e3);i.onAddRelayUrlsAfter(r)}})}const u=x(new Map),Q=c()(()=>({push(a,t,{url:e}){if(e){const i=u.get(a.id);i?i.add(e):u.set(a.id,new Set().add(e))}},feat:{getSourceUrls:$}}));function $(a){return u.get(a)}const j={duration:y.eventCacheDuration,...S},V=c()((a,t)=>{const e=Object.assign({},j,t);return{initialization(){try{const i=E(a,e);i&&this.beltline.pushEvent(i)}catch{}this.beltline.addStaff({push(i){g(i.id,i,e)}})}}});export{_ as R,z as a,Z as b,N as c,Q as d,H as e,G as f,V as g,J as h,$ as i};
