import{a8 as F,ak as u,a9 as S,ae as _,aa as T,al as x,a4 as B,a5 as E,am as z,af as D,a2 as q,a3 as N,Y as K,ai as j,a0 as G,V as M,an as $,ab as p}from"./index.7cd35645.js";import{a as A,d as C,c as J,g as V,b as Y}from"./getCacheStaff.56be5503.js";import{c as H}from"./autoAddRelayurlByEventIdStaff.abf88ad2.js";function te(){return F({push(r){if(r.created_at>u())return S.BREAK}})}const Q=r=>`createRefreshLoadStaff:${JSON.stringify(r)}`,w={..._,duration:1e3*60*30},ne=T()((r,t=20,i)=>{var b;const o=new WeakMap,v=Q(r),l=(b=x(v,w))!=null?b:{loadBufferOpt:void 0,refreshBufferOpt:{minSince:u()}},d=R(l.loadBufferOpt),h=R(l.refreshBufferOpt);return{initialization(){var a;const e=(a=i==null?void 0:i.eventBeltline)!=null?a:this.beltline;h.bufferLine=e.createChild().addStaff(A()).addStaff({push(n,s,f){if(I(n,f),h.bufferCounter.reduce(),h.bufferCounter.count<t)return e.pushEvent(n,f),S.BREAK}}).addStaffOfReverseSortByCreateAt(),d.bufferLine=e.createChild().addStaff(A()).addStaff({push(n,s,f){if(I(n,f),d.bufferCounter.reduce(),d.bufferCounter.count<t)return e.pushEvent(n,f),S.BREAK}}).addStaffOfReverseSortByCreateAt()},feat:{loadBufferOpt:d,refreshBufferOpt:h,firstLoad(){const e=this.beltline.feat.loadBufferOpt;e.isLoading=!0;const a=this.beltline,n=a.createChild().addFilters(r.map(s=>({...s,limit:t}))).addStaff(B()).addStaff(E()).addStaff({push(){e.bufferCounter.count+1>=t&&(e.isLoading=!1)}});setTimeout(()=>{e.isLoading=!1},20),a.onAddRelayUrlsAfter(s=>{n.addRelayUrls(s)}),n.addRelayUrls(a.getRelayUrls()),e.bufferLine.addExtends(n)},refresh(){const e=(a,n)=>{const s=n.until,f=n.until+n.timeIncrement;if(f>u()){if(a(),n.timeIncrement=n.timeIncrement/2,n.timeIncrement<60&&(n.timeIncrement=60),s>u()){n.until=u();return}}else n.until=f;return r.map(c=>({...c,since:s,until:f}))};L(this.beltline.feat.refreshBufferOpt,this.beltline,e)},load(){const e=(a,n)=>{const s=n.since,f=n.since=n.since-n.timeIncrement;if(!(f<1640966400&&(a(),s<1640966400)))return r.map(c=>({...c,since:f,until:s}))};L(this.beltline.feat.loadBufferOpt,this.beltline,e)}}};function L(e,a,n){if(r.length===0)return;const s=a.getRelayUrls(),f=e.bufferLine.getList(),c=f.splice(f.length-t,t);c.length<t&&k(e,s,c.length,(...g)=>{y(a);const m=n(...g);return y(a),m}),U(c,a)}function y(e){D(v,{loadBufferOpt:{timeIncrement:e.feat.loadBufferOpt.timeIncrement},refreshBufferOpt:{timeIncrement:e.feat.refreshBufferOpt.timeIncrement}},w)}function k(e,a,n,s){const f=()=>{clearInterval(e.intervalId),e.isLoading=!1};e.bufferCounter.count>t&&(e.timeIncrement=Math.floor(e.timeIncrement/(e.bufferCounter.count/t))),e.timeIncrement<60&&(e.timeIncrement=60),e.bufferCounter.set(n),f(),e.isLoading=!0,e.intervalId=setInterval(c,4e3),setTimeout(()=>c(!0));function c(g){if(e.isLoading=!0,e.bufferCounter.count>=t){f();return}else g||(e.timeIncrement=e.timeIncrement*2);const m=s(f,e);if(!!m&&a.size!==0)for(const P of a)e.bufferLine.addExtends(e.bufferLine.createChild().addStaff(E()).addStaff(B()).addFilters(m).addRelayUrl(P))}}function I(e,a){o.set(e,{event:e,opt:a})}function U(e,a){for(const n of e){const s=W(n);a.pushEvent(n,s==null?void 0:s.opt)}}function W(e){const a=o.get(e);return o.delete(e),a}function R(e){return Object.assign({bufferLine:void 0,bufferCounter:z(0),timeIncrement:600,until:u(),since:u(),createTime:u(),minSince:1640966400,intervalId:void 0,isLoading:!1},e)}}),ae=T()(()=>({initialization(){this.beltline.feat.loadBufferOpt.bufferLine.addStaff(C(),{unshift:!0}),this.beltline.feat.refreshBufferOpt.bufferLine.addStaff(C(),{unshift:!0})}}));function re(){const r=new Set;return F({push(t){if(r.has(t.content))return S.BREAK;r.add(t.content)}})}async function X(r,t,i){return new Promise((o,v)=>{const l=G({kind:5,pubkey:M.value.publicKey,tags:r.map(d=>["e",d])});K.createChild().publish(l,$(p.getWriteList(),t!=null?t:new Set),i)})}function ie(r,t){X([r],t==null?void 0:t.urls,t)}function se(r,t){return q("getEventLineById"+r,()=>{const i=N({describe:"\u83B7\u53D6Event\u901A\u8FC7id"}).addFilter({ids:[r],limit:1}).addStaff(H()).addStaff(J()).addStaff(C()).addStaff(B()).addStaff(E());if(i.addStaff(V(r)),i.feat.withEvent()||(i.addExtends(K),i.feat.withEvent()))return i;const o=async()=>{(t==null?void 0:t.urls)&&t.urls.size>0&&(i.addRelayUrls(t.urls),await i.feat.timeoutWithEvent())||t!=null&&t.pubkey&&(i.addStaff(Y(t.pubkey)),await i.feat.timeoutWithEvent())||(i.addReadUrl(),await i.feat.timeoutWithEvent())};return j(`getEventLineById:${r}`,()=>{o()},20*1e3),i},{useLocalStorage:!1})}export{ae as a,te as b,ne as c,re as d,ie as e,se as g};
