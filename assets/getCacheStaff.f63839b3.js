var L=Object.defineProperty;var M=(a,t,e)=>t in a?L(a,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):a[t]=e;var r=(a,t,e)=>(M(a,typeof t!="symbol"?t+"":t,e),e);import{a9 as h,aa as v,a5 as f,Y as R,ab as B,a3 as S,ac as w,ad as O,ae as U,af as E,ag as g,ah as C,ai as b,a1 as W,a0 as p,a4 as F,aj as x,ak as y}from"./index.5bd2a348.js";function T(){const a=new Set;return h({push(t){const e=t.id;if(a.has(e))return v.BREAK;a.add(e)}})}class k{constructor(){r(this,"interval",3e3);r(this,"maximumTimes",30);r(this,"setToBeAdded",new Set);r(this,"added",new Set);r(this,"count",0);r(this,"timer");r(this,"eventBeltline");r(this,"filterMap",new Map)}stop(){clearInterval(this.timer),this.timer=void 0}getIndex(){return Math.floor(Math.random()*this.setToBeAdded.size)}init(){}getEventBeltline(){var t;return(t=this.eventBeltline)!=null?t:this.eventBeltline=R.createChild()}startProcessing(){this.count=0,this.init(),!this.timer&&(this.timer=setInterval(()=>{this.count++;let t=this.setToBeAdded.size;if(t<=0&&(this.setToBeAdded=new Set(B.getOtherList()),t=this.setToBeAdded.size),t<=0||this.filterMap.size<=0||this.count>this.maximumTimes){this.stop();return}const e=this.getIndex(),i=Array.from(this.setToBeAdded)[e];this.added.add(i),this.setToBeAdded.delete(i);const n=Array.from(this.filterMap,([d,o])=>o),s=this.eventBeltline.createChild().addFilters(n).addStaff(S()).addRelayUrls(new Set().add(i));setTimeout(()=>{s.closeReq()},2e4),this.getEventBeltline().addExtends(s)},this.interval))}addFilter(t){for(const e of t)c.filterMap.set(JSON.stringify(e),e);c.startProcessing()}removeFilters(t){if(!!t)for(const e of t)c.filterMap.delete(JSON.stringify(e))}}const c=new k;function q(){let a=null,t=!1;function e(){t=!0,a&&c.removeFilters(a)}function i(){t=!1,a=this.beltline.getFilters();const n=this.beltline.createChild().addFilters(a).addExtends(c.getEventBeltline());this.beltline.addExtends(n),!t&&c.addFilter(a)}return h({initialization(){i.apply(this)},feat:{startAutomaticRandomRequestStaff:i,stopAutomaticRandomRequestStaff:e},onClose(){e()}})}const z=f()(()=>({initialization(){this.beltline.feat.onHasLatestEventOnce(()=>{this.beltline.feat.stopAutomaticRandomRequestStaff()})}}));function I(){const a=new w.exports.EventEmitter;return a.setMaxListeners(1e3),h({push(t,e,{lastState:i,subId:n}){const s=e[0];return(!s||t.created_at>s.created_at)&&(e[0]=t,a.emit("update",t,n)),v.BREAK},feat:{isHas(){return!!this.beltline.getList()[0]},getLatestEvent(){return this.beltline.getList()[0]},onUpdated(t){a.on("update",t)},onHasLatestEvent(t){const e=this.beltline.getList()[0];e&&t(e),a.on("update",t)},onHasLatestEventOnce(t){const e=this.beltline.getList()[0];e?t(e):a.once("update",t)}}})}const H=f()(()=>({feat:{onHasReadWriteList(a){this.beltline.feat.onHasLatestEvent((t,e)=>{const i=O(t.tags);a(i,e)})}}})),Y=f()(()=>({feat:{getReadWriteList(){return this.beltline.feat.onHasReadWriteList(a=>{this.readWriteList=a}),this.readWriteList}}})),P=f()(()=>({feat:{withEvent(){return this.beltline.getList().length>0},async timeoutWithEvent(a=2e3){return await U(2e3),this.beltline.feat.withEvent()}}}));class u{constructor(t,e){r(this,"map",{});r(this,"KEY");r(this,"cacheOption");this.cacheOption={duration:1e3*60*60*24,...E,...e==null?void 0:e.cacheOptinos},this.KEY=t;const i=localStorage.getItem(t);if(!i)return;const n=JSON.parse(i);typeof n=="object"&&(this.map=n)}allMap(){const t={},e=this.map;for(const i in e){const n=this.get(i);!n||(t[i]=n)}return t}set(t,e){const i=e.id;this.map[t]=i,g(i,e,this.cacheOption),this.updateMap()}delete(t){delete this.map[t],C(t),this.updateMap()}get(t){return this._getEvent(t)}_getEvent(t){const e=this.map[t];if(!!e)try{return b(e,this.cacheOption)}catch{this.delete(t);return}}updateMap(){localStorage.setItem(this.KEY,JSON.stringify(this.map))}}class m extends u{add(t){this.set(t.pubkey,t)}deleteEventByPubkey(t){this.delete(t)}getByPubkey(t){return this.get(t)}}const N={kind10002:new m("ReplaceableEventMap:kind10002"),kind0:new m("ReplaceableEventMap:kind0"),channelMetadataEventMap:new u("channelMetadataEventMap",{cacheOptinos:{duration:1e3*60*60*8}}),replaceable:new u("replaceable",{cacheOptinos:{duration:1e3*60*20}})},_=f()((a,t)=>({initialization(){const e=N[`kind${a}`],i=e.getByPubkey(t);i&&this.beltline.pushEvent(i),this.beltline.feat.onHasLatestEvent(n=>{e.add(n)})}}));function D(a,t){return h({initialization(){const e=this.beltline,i=W(`autoAddRelayurlByPubkey:${a}`,()=>{const s=e.createChild(),d=s.createChild().addStaff(F()).addStaff(S()).addStaff(T()),o=d.createChild().addFilter({kinds:[10002],authors:[a]}).addStaff(I()).addStaff(_(10002,a)).addStaff(H()).addStaff(P()).onAddFilters(l=>{d.addFilters(l)});return o.feat.onHasReadWriteList(l=>{s.addRelayUrls(l.writeUrl)}),x(`createAddRelayUrlGraspClues:${a}`,()=>{d.addRelayUrls(s.getRelayUrls());const l=p(A=>{d.addRelayUrls(A)},1e3);s.onAddRelayUrlsAfter(l)},y.syncInterval6),d.createChild().addFilter({kinds:[2],authors:[a]}).onAddFilters(l=>{d.addFilters(l)}).addStaff({push(l){s.addRelayUrl(l.content)}}),(async()=>{o.feat.withEvent()||(d.addExtends(R),!o.feat.withEvent()&&(t!=null&&t.urls&&(d.addRelayUrls(t.urls),await o.feat.timeoutWithEvent())||(d.addReadUrl(),!await o.feat.timeoutWithEvent()&&o.addStaff(q()).addStaff(z()))))})(),s},{useLocalStorage:!1}),n=p(s=>{e.addRelayUrls(s)},1e3);i.onAddRelayUrlsAfter(n)}})}const J={duration:y.eventCacheDuration,...E},G=f()((a,t)=>{const e=Object.assign({},J,t);return{initialization(){try{const i=b(a,e);i&&this.beltline.pushEvent(i)}catch{}this.beltline.addStaff({push(i){g(i.id,i,e)}})}}});export{N as R,P as a,T as b,I as c,D as d,_ as e,H as f,Y as g,G as h};
